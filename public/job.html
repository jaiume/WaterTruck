<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Delivery - Water Truck</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0891b2;
            --primary-dark: #0e7490;
            --secondary: #06b6d4;
            --dark: #164e63;
            --light: #ecfeff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        body {
            background: #f0fdfa;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .content {
            padding: 1.5rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .status-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        .status-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
        }
        
        .status-icon.pending {
            background: #fef3c7;
            color: #b45309;
        }
        
        .status-icon.accepted {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .status-icon.en_route {
            background: #d1fae5;
            color: #047857;
            animation: pulse 2s infinite;
        }
        
        .status-icon.delivered {
            background: #d1fae5;
            color: #047857;
        }
        
        .status-icon.expired, .status-icon.cancelled {
            background: #fee2e2;
            color: #dc2626;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .status-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .status-subtitle {
            color: #64748b;
            margin-bottom: 1.5rem;
        }
        
        .job-details {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .detail-value {
            font-weight: 600;
            color: var(--dark);
        }
        
        .truck-info {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .truck-info h5 {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .truck-info .phone {
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .truck-info .phone a {
            color: white;
            text-decoration: none;
        }
        
        .requests-list {
            background: white;
            border-radius: 16px;
            padding: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .request-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            background: #f8fafc;
        }
        
        .request-item:last-child {
            margin-bottom: 0;
        }
        
        .request-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .request-status.pending {
            background: #fef3c7;
            color: #b45309;
        }
        
        .request-status.accepted {
            background: #d1fae5;
            color: #047857;
        }
        
        .request-status.rejected, .request-status.expired {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .loading i {
            font-size: 2rem;
            color: var(--primary);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .share-prompt {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
            border: 2px dashed var(--accent);
        }
        
        .share-prompt h6 {
            color: var(--dark);
            font-weight: 700;
        }
        
        .share-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1rem;
        }
        
        .btn-share {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .btn-whatsapp {
            background: #25D366;
            color: white;
        }
        
        .btn-whatsapp:hover {
            background: #20bd5a;
            color: white;
        }
        
        .new-request-btn {
            display: block;
            text-align: center;
            padding: 1rem;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .btn-cancel {
            background: #fee2e2;
            color: var(--danger);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            width: 100%;
            margin-top: 1rem;
            transition: all 0.2s ease;
        }
        
        .btn-cancel:hover {
            background: var(--danger);
            color: white;
        }
        
        .btn-cancel:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .eta-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .eta-time {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .eta-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .eta-distance {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .eta-update {
            margin-top: 0.75rem;
            font-size: 0.75rem;
            opacity: 0.7;
        }
        
        .eta-unavailable {
            background: #f1f5f9;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #64748b;
        }
        
        .eta-unavailable i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/" class="text-decoration-none text-dark fw-semibold" id="app-header">
            <i class="bi bi-droplet-fill text-primary me-2"></i><span id="app-name">Water Truck</span>
        </a>
    </div>
    
    <div class="content">
        <div id="job-content">
            <div class="loading">
                <i class="bi bi-arrow-repeat"></i>
                <p>Loading job details...</p>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px; border: none;">
                <div class="modal-body text-center p-4">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸŽ‰</div>
                    <h4 class="fw-bold mb-3">Your truck is booked!</h4>
                    <p class="text-muted mb-4">Share the love - let friends know they can get water delivered without calling around!</p>
                    
                    <div class="share-buttons flex-column">
                        <a href="#" class="btn-share btn-whatsapp w-100" id="whatsapp-share">
                            <i class="bi bi-whatsapp"></i> Share on WhatsApp
                        </a>
                    </div>
                    
                    <button type="button" class="btn btn-link text-muted mt-3" data-bs-dismiss="modal">
                        Maybe later
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/identity.js"></script>
    <script src="/js/api.js"></script>
    <script>
        // Get job ID from URL path (e.g., /job/abc-123)
        const pathParts = window.location.pathname.split('/');
        const jobId = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];
        let currentJob = null;
        let pollInterval = null;
        let etaCountdownInterval = null;
        let currentEtaSeconds = null;
        let lastLocationUpdate = null;
        let config = { location_update_interval_seconds: 60 };
        
        // Load config
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                if (data.success) {
                    config = data.data;
                    
                    // Update header with logo if configured
                    if (config.logo) {
                        document.getElementById('app-header').innerHTML = 
                            `<img src="${config.logo}" alt="${config.app_name || 'Logo'}" style="height: 30px;">`;
                    } else if (config.app_name) {
                        document.getElementById('app-name').textContent = config.app_name;
                    }
                }
            } catch (e) {}
        }
        
        const statusConfig = {
            pending: {
                icon: 'bi-hourglass-split',
                title: 'Waiting for Truck',
                subtitle: 'Your request has been sent to available trucks'
            },
            accepted: {
                icon: 'bi-check-circle-fill',
                title: 'Truck Confirmed!',
                subtitle: 'A truck has accepted your delivery',
                showShare: true
            },
            en_route: {
                icon: 'bi-truck',
                title: 'On the Way!',
                subtitle: 'Your water is being delivered'
            },
            delivered: {
                icon: 'bi-check-all',
                title: 'Delivered!',
                subtitle: 'Your water has been delivered'
            },
            expired: {
                icon: 'bi-x-circle-fill',
                title: 'Request Expired',
                subtitle: 'No trucks were able to accept your request'
            },
            cancelled: {
                icon: 'bi-x-circle-fill',
                title: 'Cancelled',
                subtitle: 'This delivery was cancelled'
            }
        };
        
        async function loadJob() {
            if (!jobId) {
                document.getElementById('job-content').innerHTML = `
                    <div class="status-card">
                        <div class="status-icon expired">
                            <i class="bi bi-question-circle"></i>
                        </div>
                        <h3 class="status-title">Job Not Found</h3>
                        <p class="status-subtitle">Invalid or missing job ID</p>
                        <a href="/" class="btn btn-primary">Request New Delivery</a>
                    </div>
                `;
                return;
            }
            
            try {
                const response = await api.get(`/jobs/${jobId}`);
                
                if (!response.success) {
                    throw new Error(response.message || 'Job not found');
                }
                
                currentJob = response.data;
                renderJob();
                
                // Show share modal on first acceptance
                if (currentJob.status === 'accepted' && !sessionStorage.getItem(`shared_${jobId}`)) {
                    sessionStorage.setItem(`shared_${jobId}`, 'true');
                    setTimeout(() => {
                        new bootstrap.Modal(document.getElementById('shareModal')).show();
                    }, 1000);
                }
                
                // Continue polling if not in final state
                if (!['delivered', 'expired', 'cancelled'].includes(currentJob.status)) {
                    if (!pollInterval) {
                        pollInterval = setInterval(loadJob, 5000);
                    }
                } else {
                    if (pollInterval) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                    stopEtaCountdown();
                }
            } catch (error) {
                document.getElementById('job-content').innerHTML = `
                    <div class="status-card">
                        <div class="status-icon expired">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <h3 class="status-title">Error</h3>
                        <p class="status-subtitle">${escapeHtml(error.message)}</p>
                        <a href="/" class="btn btn-primary">Back to Home</a>
                    </div>
                `;
            }
        }
        
        function renderJob() {
            const job = currentJob;
            const config = statusConfig[job.status] || statusConfig.pending;
            
            let html = `
                <div class="status-card">
                    <div class="status-icon ${job.status}">
                        <i class="bi ${config.icon}"></i>
                    </div>
                    <h3 class="status-title">${config.title}</h3>
                    <p class="status-subtitle">${config.subtitle}</p>
                </div>
            `;
            
            // Show ETA if en_route
            if (job.status === 'en_route') {
                if (job.truck_location && job.truck_location.eta_minutes) {
                    // Full ETA with distance
                    const etaMin = job.truck_location.eta_minutes;
                    currentEtaSeconds = etaMin * 60;
                    lastLocationUpdate = new Date(job.truck_location.updated_at);
                    
                    html += `
                        <div class="eta-card">
                            <div class="eta-time" id="eta-display">${etaMin} min</div>
                            <div class="eta-label">Estimated arrival</div>
                            <div class="eta-distance">${job.truck_location.distance_km} km away</div>
                            <div class="eta-update" id="eta-update-info">Location updated just now</div>
                            <a href="https://www.google.com/maps?q=${job.truck_location.lat},${job.truck_location.lng}" 
                               target="_blank" class="btn btn-light btn-sm mt-2">
                                <i class="bi bi-geo-alt me-1"></i>See Truck Current Location
                            </a>
                        </div>
                    `;
                    
                    // Start countdown
                    startEtaCountdown();
                } else if (job.truck_location && job.truck_location.lat) {
                    // Truck location available but no ETA (customer didn't use GPS)
                    lastLocationUpdate = new Date(job.truck_location.updated_at);
                    
                    html += `
                        <div class="eta-card">
                            <div class="eta-time"><i class="bi bi-truck"></i></div>
                            <div class="eta-label">Truck is on the way</div>
                            <div class="eta-update" id="eta-update-info">Location updated just now</div>
                            <a href="https://www.google.com/maps?q=${job.truck_location.lat},${job.truck_location.lng}" 
                               target="_blank" class="btn btn-light btn-sm mt-2">
                                <i class="bi bi-geo-alt me-1"></i>See Truck Current Location
                            </a>
                        </div>
                    `;
                    
                    // Start location age tracking (no countdown)
                    startEtaCountdown();
                } else {
                    html += `
                        <div class="eta-unavailable">
                            <i class="bi bi-geo-alt-fill"></i>
                            <div><strong>Arrival estimate unavailable</strong></div>
                            <div>Truck location is not available at this time</div>
                        </div>
                    `;
                }
            }
            
            // Show truck info if accepted
            if (job.truck_id && job.truck_name) {
                html += `
                    <div class="truck-info">
                        <h5>${escapeHtml(job.truck_name)}</h5>
                        ${job.truck_phone ? `
                            <div class="phone">
                                <i class="bi bi-telephone"></i>
                                <a href="tel:${job.truck_phone}">${escapeHtml(job.truck_phone)}</a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Job details
            html += `
                <div class="job-details">
                    <div class="detail-row">
                        <span class="detail-label">Location</span>
                        <span class="detail-value">${escapeHtml(job.location)}</span>
                    </div>
                    ${job.price ? `
                        <div class="detail-row">
                            <span class="detail-label">Price</span>
                            <span class="detail-value">$${parseFloat(job.price).toFixed(2)}</span>
                        </div>
                    ` : ''}
                    ${job.capacity_gallons ? `
                        <div class="detail-row">
                            <span class="detail-label">Capacity</span>
                            <span class="detail-value">${job.capacity_gallons} gallons</span>
                        </div>
                    ` : ''}
                    <div class="detail-row">
                        <span class="detail-label">Created</span>
                        <span class="detail-value">${formatDate(job.created_at)}</span>
                    </div>
                </div>
            `;
            
            // Show pending requests if still pending
            if (job.status === 'pending' && job.requests && job.requests.length > 0) {
                html += `
                    <div class="requests-list">
                        <h6 class="mb-3 fw-bold">Requests Sent To:</h6>
                        ${job.requests.map(req => `
                            <div class="request-item">
                                <span>${escapeHtml(req.truck_name)}</span>
                                <span class="request-status ${req.status}">${req.status}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Show cancel button if cancellable (pending or accepted)
            if (['pending', 'accepted'].includes(job.status)) {
                html += `
                    <button class="btn-cancel" id="cancel-btn" onclick="cancelJob()">
                        <i class="bi bi-x-circle me-2"></i>Cancel Delivery
                    </button>
                `;
            }
            
            // New request button
            if (['delivered', 'expired', 'cancelled'].includes(job.status)) {
                html += `
                    <a href="/" class="new-request-btn">
                        <i class="bi bi-plus-circle me-2"></i>Request Another Delivery
                    </a>
                `;
            }
            
            document.getElementById('job-content').innerHTML = html;
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString();
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Cancel job functionality
        async function cancelJob() {
            if (!confirm('Are you sure you want to cancel this delivery?')) {
                return;
            }
            
            const btn = document.getElementById('cancel-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Cancelling...';
            
            try {
                const response = await api.post(`/jobs/${jobId}/cancel`);
                
                if (response.success) {
                    currentJob = response.data;
                    renderJob();
                    if (pollInterval) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                } else {
                    alert(response.message || 'Failed to cancel');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Cancel Delivery';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Cancel Delivery';
            }
        }
        
        // Share functionality
        const shareMessage = "I just booked a private water truck without calling around! You can see price, capacity and delivery time here:";
        const shareUrl = window.location.origin;
        
        document.getElementById('whatsapp-share').href = 
            `https://wa.me/?text=${encodeURIComponent(shareMessage + ' ' + shareUrl)}`;
        
        // ETA countdown functions
        function startEtaCountdown() {
            if (etaCountdownInterval) clearInterval(etaCountdownInterval);
            
            etaCountdownInterval = setInterval(() => {
                if (currentEtaSeconds > 0) {
                    currentEtaSeconds--;
                    updateEtaDisplay();
                }
                updateLocationAgeDisplay();
            }, 1000);
        }
        
        function updateEtaDisplay() {
            const display = document.getElementById('eta-display');
            if (!display) return;
            
            if (currentEtaSeconds <= 0) {
                display.textContent = 'Arriving';
            } else if (currentEtaSeconds < 60) {
                display.textContent = `< 1 min`;
            } else {
                const mins = Math.ceil(currentEtaSeconds / 60);
                display.textContent = `${mins} min`;
            }
        }
        
        function updateLocationAgeDisplay() {
            const updateInfo = document.getElementById('eta-update-info');
            if (!updateInfo || !lastLocationUpdate) return;
            
            const ageSeconds = Math.floor((Date.now() - lastLocationUpdate.getTime()) / 1000);
            
            if (ageSeconds < 10) {
                updateInfo.textContent = 'Location updated just now';
            } else if (ageSeconds < 60) {
                updateInfo.textContent = `Location updated ${ageSeconds}s ago`;
            } else {
                const ageMins = Math.floor(ageSeconds / 60);
                updateInfo.textContent = `Location updated ${ageMins}m ago`;
            }
            
            // Show warning if location is stale
            const intervalSecs = config.location_update_interval_seconds || 60;
            if (ageSeconds > intervalSecs * 2) {
                updateInfo.textContent += ' (may be outdated)';
            }
        }
        
        function stopEtaCountdown() {
            if (etaCountdownInterval) {
                clearInterval(etaCountdownInterval);
                etaCountdownInterval = null;
            }
        }
        
        // Initialize
        loadConfig().then(() => loadJob());
    </script>
</body>
</html>
